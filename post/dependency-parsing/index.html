<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Project: Dependency Parsing Using Deep Learning NN Model - Luyao Peng&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Luyao Peng" /><meta name="description" content="This project extends Neural Transition-based dependeny Parsing (Stanford U cs224n A#2 Q2). The goal is to build a three layer neural network using TensorFlow to parse the dependency structure of sentences. The orignal code contributed by hankcs is built in Python2. I revised it so it runs in Python3. The training data for the neural dependency parsing model is Penn Treebank, and each sentence has &amp;lsquo;word&amp;rsquo;, &amp;lsquo;POS&amp;rsquo;, &amp;lsquo;head&amp;rsquo; and &amp;lsquo;label&amp;rsquo;," /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.73.0 with even 4.0.0" />


<link rel="canonical" href="/post/dependency-parsing/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Project: Dependency Parsing Using Deep Learning NN Model" />
<meta property="og:description" content="This project extends Neural Transition-based dependeny Parsing (Stanford U cs224n A#2 Q2). The goal is to build a three layer neural network using TensorFlow to parse the dependency structure of sentences. The orignal code contributed by hankcs is built in Python2. I revised it so it runs in Python3. The training data for the neural dependency parsing model is Penn Treebank, and each sentence has &lsquo;word&rsquo;, &lsquo;POS&rsquo;, &lsquo;head&rsquo; and &lsquo;label&rsquo;," />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/dependency-parsing/" />
<meta property="article:published_time" content="2011-08-30T16:01:23+08:00" />
<meta property="article:modified_time" content="2018-11-05T16:01:23+08:00" />
<meta itemprop="name" content="Project: Dependency Parsing Using Deep Learning NN Model">
<meta itemprop="description" content="This project extends Neural Transition-based dependeny Parsing (Stanford U cs224n A#2 Q2). The goal is to build a three layer neural network using TensorFlow to parse the dependency structure of sentences. The orignal code contributed by hankcs is built in Python2. I revised it so it runs in Python3. The training data for the neural dependency parsing model is Penn Treebank, and each sentence has &lsquo;word&rsquo;, &lsquo;POS&rsquo;, &lsquo;head&rsquo; and &lsquo;label&rsquo;,">
<meta itemprop="datePublished" content="2011-08-30T16:01:23&#43;08:00" />
<meta itemprop="dateModified" content="2018-11-05T16:01:23&#43;08:00" />
<meta itemprop="wordCount" content="6299">



<meta itemprop="keywords" content="NLP,Deep Learning," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Project: Dependency Parsing Using Deep Learning NN Model"/>
<meta name="twitter:description" content="This project extends Neural Transition-based dependeny Parsing (Stanford U cs224n A#2 Q2). The goal is to build a three layer neural network using TensorFlow to parse the dependency structure of sentences. The orignal code contributed by hankcs is built in Python2. I revised it so it runs in Python3. The training data for the neural dependency parsing model is Penn Treebank, and each sentence has &lsquo;word&rsquo;, &lsquo;POS&rsquo;, &lsquo;head&rsquo; and &lsquo;label&rsquo;,"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">LP&#39;s NLP Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">LP&#39;s NLP Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<script async type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Project: Dependency Parsing Using Deep Learning NN Model</h1>

      <div class="post-meta">
        <span class="post-time"> 2011-08-30 </span>
        <div class="post-category">
            <a href="/categories/nlp/"> NLP </a>
            <a href="/categories/my-projects/"> My Projects </a>
            </div>
        
      </div>
    </header>

    
    <div class="post-content">
      <p>This project extends Neural Transition-based dependeny Parsing (Stanford U cs224n A#2 Q2). The goal is to build a three layer neural network using TensorFlow to parse the dependency structure of sentences. The <a href="https://github.com/hankcs/CS224n/tree/master/assignment2">orignal code</a> contributed by <a href="https://github.com/hankcs">hankcs</a> is built in Python2. I revised it so it runs in Python3. The training data for the neural dependency parsing model is Penn Treebank, and each sentence has &lsquo;word&rsquo;, &lsquo;POS&rsquo;, &lsquo;head&rsquo; and &lsquo;label&rsquo;, where the &lsquo;head&rsquo; is the correct dependency relation.</p>
<p>First, import necessary modules and set up the configurations for the parser:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">P_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;:&#39;</span>
<span class="n">L_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;&lt;l&gt;:&#39;</span>
<span class="n">UNK</span> <span class="o">=</span> <span class="s1">&#39;&lt;UNK&gt;&#39;</span>
<span class="n">NULL</span> <span class="o">=</span> <span class="s1">&#39;&lt;NULL&gt;&#39;</span>
<span class="n">ROOT</span> <span class="o">=</span> <span class="s1">&#39;&lt;ROOT&gt;&#39;</span>

<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> 
    <span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;english&#39;</span>
    <span class="n">with_punct</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">unlabeled</span> <span class="o">=</span> <span class="bp">True</span> 
    <span class="n">lowercase</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">use_pos</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># use part of speech as input features</span>
    <span class="n">use_dep</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1">#?</span>
    <span class="n">use_dep</span> <span class="o">=</span> <span class="n">use_dep</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">unlabeled</span><span class="p">)</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;./data&#39;</span>
    <span class="n">train_file</span> <span class="o">=</span> <span class="s1">&#39;train.conll&#39;</span>
    <span class="n">dev_file</span> <span class="o">=</span> <span class="s1">&#39;dev.conll&#39;</span>
    <span class="n">test_file</span> <span class="o">=</span> <span class="s1">&#39;test.conll&#39;</span>
    <span class="n">embedding_file</span> <span class="o">=</span> <span class="s1">&#39;./data/en-cw.txt&#39;</span>   
    <span class="n">n_features</span> <span class="o">=</span> <span class="mi">36</span> <span class="c1">#?</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># want to predict shift, left-arc or right-arc</span>
    <span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">embed_size</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2048</span>
    <span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span>
</code></pre></td></tr></table>
</div>
</div><p>Define some utility functions:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># read the training data in:</span>
<span class="c1"># The first 5 rows in the training data:</span>
<span class="s1">&#39;&#39;&#39;
</span><span class="s1">1	In	_	ADP	IN	_	5	case	_	_
</span><span class="s1">2	an	_	DET	DT	_	5	det	_	_
</span><span class="s1">3	Oct.	_	PROPN	NNP	_	5	compound	_	_
</span><span class="s1">4	19	_	NUM	CD	_	5	nummod	_	_
</span><span class="s1">5	review	_	NOUN	NN	_	45	nmod	_	_
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">read_conll</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">lowercase</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">max_example</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">word</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#tokenize each line of the file</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1">#that means the sentence is not complete, continue accumulate words in the sentence</span>
                    <span class="n">word</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">lowercase</span> <span class="k">else</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">head</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
                    <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#accumulate to a dictionary</span>
                <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;word&#39;</span><span class="p">:</span> <span class="n">word</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="n">head</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>
                <span class="n">word</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">max_example</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_example</span><span class="p">):</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#if the sentence has &gt;0 words, accumulate the sentence dictionary to a list called examples.</span>
            <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;word&#39;</span><span class="p">:</span> <span class="n">word</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="n">head</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">examples</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">build_dict</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span> <span class="k">if</span> <span class="n">n_max</span> <span class="ow">is</span> <span class="bp">None</span> \
        <span class="k">else</span> <span class="n">count</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">n_max</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">index</span> <span class="o">+</span> <span class="n">offset</span> <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">punct</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;english&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pos</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;&#39;&#39;&#34;</span><span class="p">,</span> <span class="s2">&#34;,&#34;</span><span class="p">,</span> <span class="s2">&#34;.&#34;</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;``&#34;</span><span class="p">,</span> <span class="s2">&#34;-LRB-&#34;</span><span class="p">,</span> <span class="s2">&#34;-RRB-&#34;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;chinese&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;PU&#39;</span>
    <span class="k">elif</span> <span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;french&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;PUNC&#39;</span>
    <span class="k">elif</span> <span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;german&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pos</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;$.&#34;</span><span class="p">,</span> <span class="s2">&#34;$,&#34;</span><span class="p">,</span> <span class="s2">&#34;$[&#34;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;spanish&#39;</span><span class="p">:</span>
        <span class="c1"># http://nlp.stanford.edu/software/spanish-faq.shtml</span>
        <span class="k">return</span> <span class="n">pos</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;f0&#34;</span><span class="p">,</span> <span class="s2">&#34;faa&#34;</span><span class="p">,</span> <span class="s2">&#34;fat&#34;</span><span class="p">,</span> <span class="s2">&#34;fc&#34;</span><span class="p">,</span> <span class="s2">&#34;fd&#34;</span><span class="p">,</span> <span class="s2">&#34;fe&#34;</span><span class="p">,</span> <span class="s2">&#34;fg&#34;</span><span class="p">,</span> <span class="s2">&#34;fh&#34;</span><span class="p">,</span>
                       <span class="s2">&#34;fia&#34;</span><span class="p">,</span> <span class="s2">&#34;fit&#34;</span><span class="p">,</span> <span class="s2">&#34;fp&#34;</span><span class="p">,</span> <span class="s2">&#34;fpa&#34;</span><span class="p">,</span> <span class="s2">&#34;fpt&#34;</span><span class="p">,</span> <span class="s2">&#34;fs&#34;</span><span class="p">,</span> <span class="s2">&#34;ft&#34;</span><span class="p">,</span>
                       <span class="s2">&#34;fx&#34;</span><span class="p">,</span> <span class="s2">&#34;fz&#34;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;universal&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;PUNCT&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;language: </span><span class="si">%s</span><span class="s1"> is not supported.&#39;</span> <span class="o">%</span> <span class="n">language</span><span class="p">)</span>


</code></pre></td></tr></table>
</div>
</div><p>Now, define Preprocessor object (in the assignment it is called Parser. I was confused about the parse method in that object, so I take the parse method out as an independent method, so the Parser object was renamed as Preprocessor, which will be used as an argument in the parse() method)  to extract features of the context words of each word in the training data (word, pos, label features), get the correct transitions, get the legal transitions , then create instances containing [a long list of tuples of (features, legal labels, gold_t (correct transitions))]</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Preprocessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># initialize the dictionary {token: id}, and {id: token},  </span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="n">root_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">l</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">dataset</span>
                           <span class="k">for</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">],</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="c1">#h==0 is root</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">root_labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning: more than one root label&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_label</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">deprel</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_label</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">dataset</span>
                                               <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                                               <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_label</span><span class="p">]))</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        the deprel (dependent relations) are:
</span><span class="s1">        
</span><span class="s1">        &#39;&#39;&#39;</span>
        
        <span class="n">tok2id</span> <span class="o">=</span> <span class="p">{</span><span class="n">L_PREFIX</span> <span class="o">+</span> <span class="n">l</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deprel</span><span class="p">)}</span>
        <span class="n">tok2id</span><span class="p">[</span><span class="n">L_PREFIX</span> <span class="o">+</span> <span class="n">NULL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_NULL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlabeled</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">unlabeled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_punct</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">with_punct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pos</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">use_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_dep</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">use_dep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">language</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unlabeled</span><span class="p">:</span> <span class="c1">#just S, LA, RA</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#S_NN</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L-&#39;</span> <span class="o">+</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deprel</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;R-&#39;</span> <span class="o">+</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deprel</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">deprel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_trans</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tran2id</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trans</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id2tran</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trans</span><span class="p">)}</span>
        
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        example of id2tran is:
</span><span class="s1">        {0: &#39;L&#39;, 1: &#39;R&#39;, 2: &#39;S&#39;}
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="c1"># logging.info(&#39;Build dictionary for part-of-speech tags.&#39;)</span>
        <span class="n">tok2id</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">build_dict</span><span class="p">([</span><span class="n">P_PREFIX</span> <span class="o">+</span> <span class="n">w</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]],</span>
                                  <span class="n">offset</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)))</span>
        <span class="n">tok2id</span><span class="p">[</span><span class="n">P_PREFIX</span> <span class="o">+</span> <span class="n">UNK</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_UNK</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)</span>
        <span class="n">tok2id</span><span class="p">[</span><span class="n">P_PREFIX</span> <span class="o">+</span> <span class="n">NULL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)</span>
        <span class="n">tok2id</span><span class="p">[</span><span class="n">P_PREFIX</span> <span class="o">+</span> <span class="n">ROOT</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_ROOT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)</span>

        <span class="c1"># logging.info(&#39;Build dictionary for words.&#39;)</span>
        <span class="n">tok2id</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">build_dict</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">]],</span>
                                  <span class="n">offset</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)))</span>
        <span class="n">tok2id</span><span class="p">[</span><span class="n">UNK</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNK</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)</span>
        <span class="n">tok2id</span><span class="p">[</span><span class="n">NULL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NULL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)</span>
        <span class="n">tok2id</span><span class="p">[</span><span class="n">ROOT</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROOT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)</span>
        
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        example of id2tok is:
</span><span class="s1">        {0: &#39;&lt;l&gt;:root&#39;, 1: &#39;&lt;l&gt;:nsubj&#39;, 2: &#39;&lt;l&gt;:advmod&#39;, 3: &#39;&lt;l&gt;:dobj&#39;, 4: &#39;&lt;l&gt;:acl&#39;, 5: &#39;&lt;l&gt;:nummod&#39;, 6: &#39;&lt;l&gt;:nmod&#39;, 7: &#39;&lt;l&gt;:compound&#39;, 8: &#39;&lt;l&gt;:xcomp&#39;, 
</span><span class="s1">        9: &#39;&lt;l&gt;:auxpass&#39;, 10: &#39;&lt;l&gt;:det&#39;, 11: &#39;&lt;l&gt;:punct&#39;, 12: &#39;&lt;l&gt;:mark&#39;, 13: &#39;&lt;l&gt;:case&#39;, 14: &#39;&lt;l&gt;:conj&#39;, 15: &#39;&lt;l&gt;:appos&#39;, 16: &#39;&lt;l&gt;:nmod:tmod&#39;, 
</span><span class="s1">        17: &#39;&lt;l&gt;:dep&#39;, 18: &#39;&lt;l&gt;:amod&#39;, 19: &#39;&lt;l&gt;:nmod:poss&#39;, 20: &#39;&lt;l&gt;:nsubjpass&#39;, 21: &#39;&lt;l&gt;:cc&#39;, 22: &#39;&lt;l&gt;:ccomp&#39;, 23: &#39;&lt;l&gt;:&lt;NULL&gt;&#39;, 24: &#39;&lt;p&gt;:NNP&#39;, 
</span><span class="s1">        25: &#39;&lt;p&gt;:NN&#39;, 26: &#39;&lt;p&gt;:IN&#39;, 27: &#39;&lt;p&gt;:DT&#39;, 28: &#39;&lt;p&gt;:,&#39;, 29: &#39;&lt;p&gt;:NNS&#39;, 30: &#39;&lt;p&gt;:JJ&#39;, 31: &#39;&lt;p&gt;:CD&#39;, 32: &#39;&lt;p&gt;:CC&#39;, 33: &#39;&lt;p&gt;:VBD&#39;, 34: &#39;&lt;p&gt;:.&#39;, 
</span><span class="s1">        35: &#39;&lt;p&gt;:VBN&#39;, 36: &#39;&lt;p&gt;:VBZ&#39;, 37: &#39;&lt;p&gt;:``&#39;, 38: &#34;&lt;p&gt;:&#39;&#39;&#34;, 39: &#39;&lt;p&gt;:VB&#39;, 40: &#39;&lt;p&gt;:TO&#39;, 41: &#39;&lt;p&gt;:PRP&#39;, 42: &#39;&lt;p&gt;:POS&#39;, 43: &#39;&lt;p&gt;:-LRB-&#39;, 
</span><span class="s1">        44: &#39;&lt;p&gt;:-RRB-&#39;, 45: &#39;&lt;p&gt;:RB&#39;, 46: &#39;&lt;p&gt;:NNPS&#39;, 47: &#39;&lt;p&gt;:PRP$&#39;, 48: &#39;&lt;p&gt;:&lt;UNK&gt;&#39;, 49: &#39;&lt;p&gt;:&lt;NULL&gt;&#39;, 50: &#39;&lt;p&gt;:&lt;ROOT&gt;&#39;, 51: &#39;,&#39;, 52: &#39;in&#39;, 53: &#39;the&#39;, 
</span><span class="s1">        54: &#39;.&#39;, 55: &#39;cars&#39;, 56: &#39;and&#39;, 57: &#39;of&#39;, 58: &#39;``&#39;, 59: &#34;&#39;&#39;&#34;, 60: &#39;at&#39;, 61: &#39;to&#39;, 62: &#39;haag&#39;, 63: &#39;said&#39;, 64: &#39;u.s.&#39;, 65: &#39;luxury&#39;, 66: &#39;auto&#39;, 
</span><span class="s1">        67: &#39;maker&#39;, 68: &#39;an&#39;, 69: &#39;oct.&#39;, 70: &#39;19&#39;, 71: &#39;review&#39;, 72: &#39;misanthrope&#39;, 73: &#39;chicago&#39;, 74: &#34;&#39;s&#34;, 75: &#39;goodman&#39;, 76: &#39;theatre&#39;, 77: &#39;-lrb-&#39;, 
</span><span class="s1">        78: &#39;revitalized&#39;, 79: &#39;classics&#39;, 80: &#39;take&#39;, 81: &#39;stage&#39;, 82: &#39;windy&#39;, 83: &#39;city&#39;, 84: &#39;leisure&#39;, 85: &#39;&amp;&#39;, 86: &#39;arts&#39;, 87: &#39;-rrb-&#39;, 88: &#39;role&#39;,
</span><span class="s1">        89: &#39;celimene&#39;, 90: &#39;played&#39;, 91: &#39;by&#39;, 92: &#39;kim&#39;, 93: &#39;cattrall&#39;, 94: &#39;was&#39;, 95: &#39;mistakenly&#39;, 96: &#39;attributed&#39;, 97: &#39;christina&#39;, 98: &#39;ms.&#39;, 
</span><span class="s1">        99: &#39;plays&#39;, 100: &#39;elianti&#39;, 101: &#39;rolls-royce&#39;, 102: &#39;motor&#39;, 103: &#39;inc.&#39;, 104: &#39;it&#39;, 105: &#39;expects&#39;, 106: &#39;its&#39;, 107: &#39;sales&#39;, 108: &#39;remain&#39;, 
</span><span class="s1">        109: &#39;steady&#39;, 110: &#39;about&#39;, 111: &#39;1,200&#39;, 112: &#39;1990&#39;, 113: &#39;last&#39;, 114: &#39;year&#39;, 115: &#39;sold&#39;, 116: &#39;1,214&#39;, 117: &#39;howard&#39;, 118: &#39;mosher&#39;, 
</span><span class="s1">        119: &#39;president&#39;, 120: &#39;chief&#39;, 121: &#39;executive&#39;, 122: &#39;officer&#39;, 123: &#39;he&#39;, 124: &#39;anticipates&#39;, 125: &#39;growth&#39;, 126: &#39;for&#39;, 127: &#39;britain&#39;, 
</span><span class="s1">        128: &#39;europe&#39;, 129: &#39;far&#39;, 130: &#39;eastern&#39;, 131: &#39;markets&#39;, 132: &#39;&lt;UNK&gt;&#39;, 133: &#39;&lt;NULL&gt;&#39;, 134: &#39;&lt;ROOT&gt;&#39;}
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tok2id</span> <span class="o">=</span> <span class="n">tok2id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id2tok</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tok2id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span> <span class="o">=</span> <span class="mi">18</span> <span class="o">+</span> <span class="p">(</span><span class="mi">18</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_pos</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_dep</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#? why 18?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok2id</span><span class="p">)</span> 
    
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    arranging each set as this form: [{&#39;word&#39;: [corresponding id of each token], &#39;pos&#39;: [corresponding id in pos from tok2id], &#39;head&#39;: [id...], &#39;label&#39;: [id...]},...,      #{last sentence in the set}]
</span><span class="s1">        The resulting vec_examples are (this is vectorized training data in id form from tok2id):
</span><span class="s1">        [{&#39;word&#39;: [134, 52, 68, 69, 70, 71, 57, 58, 53, 72, 59, 60, 73, 74, 75, 76, 77, 58, 78, 79, 80, 53, 81, 52, 82, 83, 51, 59, 84, 85, 86, 87, 51, 53, 88, 57, 89, 51, 90, 91, 92, 93, 51, 94, 95, 96, 61, 97, 62, 54], 
</span><span class="s1">        &#39;pos&#39;: [50, 26, 27, 24, 31, 25, 26, 37, 27, 25, 38, 26, 24, 42, 24, 24, 43, 37, 35, 29, 39, 27, 25, 26, 24, 24, 28, 38, 25, 32, 29, 44, 28, 27, 25, 26, 24, 28, 35, 26, 24, 24, 28, 33, 45, 35, 40, 24, 24, 34], 
</span><span class="s1">        &#39;head&#39;: [-1, 5, 5, 5, 5, 45, 9, 9, 9, 5, 9, 15, 15, 12, 15, 9, 20, 20, 19, 20, 5, 22, 20, 25, 25, 20, 20, 20, 20, 28, 28, 20, 45, 34, 45, 36, 34, 34, 34, 41, 41, 38, 34, 45, 45, 0, 48, 48, 45, 45], 
</span><span class="s1">        &#39;label&#39;: [-1, 13, 10, 7, 5, 6, 13, 11, 10, 6, 11, 13, 19, 13, 7, 6, 11, 11, 18, 1, 17, 10, 3, 13, 7, 6, 11, 11, 17, 21, 14, 11, 11, 10, 20, 13, 6, 11, 4, 13, 7, 6, 11, 9, 2, 0, 13, 7, 6, 11]}, 
</span><span class="s1">        {&#39;word&#39;: [134, 98, 62, 99, 100, 54], &#39;pos&#39;: [50, 24, 24, 36, 24, 34], &#39;head&#39;: [-1, 2, 3, 0, 3, 3], &#39;label&#39;: [-1, 7, 1, 0, 3, 11]},{...}...{...}
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">vectorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">examples</span><span class="p">):</span> 
        <span class="n">vec_examples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROOT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tok2id</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok2id</span>
                                  <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNK</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">]]</span> <span class="c1"># a list of word id for each sentence in dataset</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">P_ROOT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tok2id</span><span class="p">[</span><span class="n">P_PREFIX</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="k">if</span> <span class="n">P_PREFIX</span> <span class="o">+</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok2id</span> <span class="c1"># a list of POS id</span>
                                   <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_UNK</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]]</span>
            <span class="n">head</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tok2id</span><span class="p">[</span><span class="n">L_PREFIX</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="k">if</span> <span class="n">L_PREFIX</span> <span class="o">+</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok2id</span>
                            <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]]</span>
            <span class="n">vec_examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;word&#39;</span><span class="p">:</span> <span class="n">word</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                 <span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="n">head</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">vec_examples</span> <span class="c1"># each sentence is a dictionary with list of &#39;word&#39;,&#39;POS&#39;, &#39;head&#39; and &#39;label</span>
    
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    This function is important, it extracts context words first, then extract the corresping word from ex[&#39;word&#39;], pos from ex[&#39;pos&#39;]
</span><span class="s1">    and label features from ex[&#39;label&#39;], finally concatenate them into a long vector for each sentence, an example of one set of features for one sentence is:
</span><span class="s1">    [133, 133, 134, 52, 68, 69, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 49, 49, 50, 26, 27, 24, 49, 49, 49, 49, 49, 49, 49, 49, 49, 49, 49, 49] #36 features of context words with corresponding id from tok2id,  that is a long list containing [features, p_features, l_features] 
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">arcs</span><span class="p">,</span> <span class="n">ex</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;ROOT&#34;</span><span class="p">:</span>
            <span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">get_lc</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="c1"># lc: left context, since arc = (stack[-1], stack[-2], gold_t) or (stack[-2], stack[-1], gold_t), if arc[1]&#39;s id &lt; arc[0]&#39;s id, then extract lc</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">arc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arc</span> <span class="ow">in</span> <span class="n">arcs</span> <span class="k">if</span> <span class="n">arc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">arc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">get_rc</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="c1">#if arc[1]&#39;s id &gt; arc[0]&#39;s id, rc</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">arc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arc</span> <span class="ow">in</span> <span class="n">arcs</span> <span class="k">if</span> <span class="n">arc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">arc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">],</span>
                          <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">p_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">l_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]]</span> <span class="c1">#if len(stack)&gt;=3, no NULL, features contain the last 3 words in the stack</span>
        <span class="n">features</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="c1"># extract the first 3 words in the buffer if len(buf) &gt;=3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pos</span><span class="p">:</span> <span class="c1"># extracting the corresponding pos features, 3 from stack, 3 from buffer if stack and buffer have length&gt;=3</span>
            <span class="n">p_features</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]]</span>
            <span class="n">p_features</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="c1">#i = 0, 1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#the kth word&#39;s context: i=0, the -1 word&#39;s context, i=1, the -2 word&#39;s context</span>
                <span class="n">lc</span> <span class="o">=</span> <span class="n">get_lc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># the left context word of kth word in stack = [(s3,) s2, s1]</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">get_rc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># the right context word</span>
                <span class="n">llc</span> <span class="o">=</span> <span class="n">get_lc</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span> <span class="c1">#llc</span>
                <span class="n">rrc</span> <span class="o">=</span> <span class="n">get_rc</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span> <span class="c1">#rrc</span>

                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">)</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">][</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">)</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">)</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">][</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">)</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">][</span><span class="n">llc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">llc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">)</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">][</span><span class="n">rrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rrc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pos</span><span class="p">:</span>
                    <span class="n">p_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">)</span>
                    <span class="n">p_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">)</span>
                    <span class="n">p_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">)</span>
                    <span class="n">p_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">)</span>
                    <span class="n">p_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">llc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">llc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">)</span>
                    <span class="n">p_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">rrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rrc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dep</span><span class="p">:</span>
                    <span class="n">l_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_NULL</span><span class="p">)</span>
                    <span class="n">l_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_NULL</span><span class="p">)</span>
                    <span class="n">l_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_NULL</span><span class="p">)</span>
                    <span class="n">l_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_NULL</span><span class="p">)</span>
                    <span class="n">l_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">llc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">llc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_NULL</span><span class="p">)</span>
                    <span class="n">l_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">rrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rrc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_NULL</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">features</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NULL</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pos</span><span class="p">:</span>
                    <span class="n">p_features</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">P_NULL</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dep</span><span class="p">:</span>
                    <span class="n">l_features</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">L_NULL</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>

        <span class="n">features</span> <span class="o">+=</span> <span class="n">p_features</span> <span class="o">+</span> <span class="n">l_features</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span>
        <span class="k">return</span> <span class="n">features</span> 

    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    This is to get the correct transitions for training purposes. 
</span><span class="s1">    1. if there is only ROOT in stack, the only correct transition is shift
</span><span class="s1">    2. if stack = [i1, i0] or more, i2 is not ROOT, i1&#39;s head == i0, then left arc is the correct transition
</span><span class="s1">    3. if stack = [i1, i0] or more, i0&#39;s head == i1, i1 can be ROOT or not ROOT, right arc is the correct transition
</span><span class="s1">    4. ow shift
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">get_oracle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ex</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_trans</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1">#如果stack只有root, 就执行shift, shift对应id是48 or 2: n_tran = 3-1 if unlabel or 49-1  if label1</span>
        <span class="n">i0</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span>
        <span class="n">l0</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unlabeled</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h1</span> <span class="o">==</span> <span class="n">i0</span><span class="p">):</span> <span class="c1">#if i1 is not ROOT, stack[i1, i0], head is i0, left_arc i1</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">i1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h0</span> <span class="o">==</span> <span class="n">i1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">buf</span> <span class="k">if</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">i0</span><span class="p">])):</span> 
                <span class="k">return</span> <span class="mi">1</span> <span class="c1"># if head is i1, no i0 head in buffer , right_arc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">2</span> <span class="c1">#if len(buf) =0, no transition, ow, shift</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h1</span> <span class="o">==</span> <span class="n">i0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">l1</span> <span class="k">if</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">i1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h0</span> <span class="o">==</span> <span class="n">i1</span><span class="p">)</span> <span class="ow">and</span> \
                 <span class="p">(</span><span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">buf</span> <span class="k">if</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">i0</span><span class="p">])):</span>
                <span class="k">return</span> <span class="n">l0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span> <span class="k">if</span> <span class="p">(</span><span class="n">l0</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">l0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_trans</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    for each sentence in training data, create stack with only ROOT in id form [0], buf with all tokens of the sentence, and empty arcs, get oracle for the 
</span><span class="s1">    stack[ROOT] and full buffer (oracle should be shift for this case), get legal labels (only shift is legal for stack[ROOT] and full buffer), so in this
</span><span class="s1">    round the legal_labels will return [0,0,1], then update stack, buffer and arcs, repeate this procedure for the updated stack, buffer and arcs for 
</span><span class="s1">    2*#ofwords times. for each update, instances are accumulated as walking through the whole sentence as [], each sentence is an instances, all_instances  =
</span><span class="s1">    [[instances1], [instances2], ...[]]
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">create_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">examples</span><span class="p">):</span>
        <span class="n">all_instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">succ</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n_ex</span><span class="p">,</span> <span class="n">ex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
            <span class="n">n_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># arcs = {(h, t, label)}</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_words</span><span class="p">)]</span>
            <span class="n">arcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_words</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span> <span class="c1"># rolling over each word to get the features (legal label and gold_t) for each transition in (llc, lc, w, rc, rrc) for each sentence, the transitions have 2*n_word times </span>
                <span class="n">gold_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_oracle</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gold_t</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">legal_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">legal_labels</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">legal_labels</span><span class="p">[</span><span class="n">gold_t</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1"># correct transition must belong to legal lables</span>
                <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">arcs</span><span class="p">,</span> <span class="n">ex</span><span class="p">),</span>
                                  <span class="n">legal_labels</span><span class="p">,</span> <span class="n">gold_t</span><span class="p">))</span> 
                <span class="k">if</span> <span class="n">gold_t</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_trans</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># gold_t is shift= 2</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">elif</span> <span class="n">gold_t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span><span class="p">:</span> <span class="c1">#n_deprel = 1, when gold_t ==0,</span>
                    <span class="n">arcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">gold_t</span><span class="p">))</span> <span class="c1"># i.e. L_arc, next gold_t must be 2, i.e. shift, stack is all the words except the -2 word, then next loop will be adding the first word in buffer to stack (execute the first if).</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gold_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span><span class="p">))</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#when gold_t ==1, R_arc, next gold_t must be 0, i.e. shift, stack will be all the words except the last word, then next loop will be adding the first word in buffer to stack (execute the first if).</span>
            <span class="n">succ</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">all_instances</span> <span class="o">+=</span> <span class="n">instances</span> <span class="c1"># one instance is one sentence with 2*n_word tuples, each tuple contains context features, legal_labels, gold_t</span>
        <span class="k">return</span> <span class="n">all_instances</span>

    <span class="k">def</span> <span class="nf">legal_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span> <span class="c1">#stack&lt;=2 must not be L-arc, stack&gt;2, L-arc is legal</span>
        <span class="n">labels</span> <span class="o">+=</span> <span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_deprel</span>
        <span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#buf &gt; 0,  shift is legal </span>
        <span class="k">return</span> <span class="n">labels</span> <span class="c1"># labels&#39; length == n_tran, 3 or 49</span>
</code></pre></td></tr></table>
</div>
</div><p>After defining the Preprocessor, it is ready to load and preprocess data. It read in the train set, dev set and test set first, and slice sentences for debugging purpose, initialize Preprocessor, initalize embedding matrix for all tokens in train set and then map each row in embedding matrix to corresponding token (this is the pretrained embedding matrix), vectorize train, dev and test sets.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">load_and_preprocess_data</span><span class="p">(</span><span class="n">reduced</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Loading data...&#34;</span><span class="p">),</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">train_set</span> <span class="o">=</span> <span class="n">read_conll</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">train_file</span><span class="p">),</span>
                           <span class="n">lowercase</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">lowercase</span><span class="p">)</span>
    <span class="n">dev_set</span> <span class="o">=</span> <span class="n">read_conll</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dev_file</span><span class="p">),</span>
                         <span class="n">lowercase</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">lowercase</span><span class="p">)</span>
    <span class="n">test_set</span> <span class="o">=</span> <span class="n">read_conll</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">test_file</span><span class="p">),</span>
                          <span class="n">lowercase</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">lowercase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reduced</span><span class="p">:</span>
        <span class="n">train_set</span> <span class="o">=</span> <span class="n">train_set</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
        <span class="n">dev_set</span> <span class="o">=</span> <span class="n">dev_set</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>
        <span class="n">test_set</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;took {:.2f} seconds&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Building parser...&#34;</span><span class="p">),</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;took {:.2f} seconds&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Loading pretrained embeddings...&#34;</span><span class="p">),</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">word_vectors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">embedding_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">word_vectors</span><span class="p">[</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="c1">#sp[0] is all vocabulary, sp[1:] is the corresponding word vector </span>
    <span class="n">embeddings_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">n_tokens</span><span class="p">,</span> <span class="mi">50</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="c1">#embeding: is n_tokens * 50</span>

    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">tok2id</span><span class="p">:</span> <span class="c1">#all token/ POS/ label in train set</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">tok2id</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">word_vectors</span><span class="p">:</span>
            <span class="n">embeddings_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">word_vectors</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">word_vectors</span><span class="p">:</span>
            <span class="n">embeddings_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">word_vectors</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="c1">#fill embedding matrix with corresponding word_vectors as input x</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;took {:.2f} seconds&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Vectorizing data...&#34;</span><span class="p">),</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">train_set</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span>
    <span class="n">dev_set</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">dev_set</span><span class="p">)</span> <span class="c1"># each sentence conresponds to a dictionary of {&#39;word&#39;:id, &#39;head&#39;: id, &#39;pos&#39;: id, &#39;label&#39;: id}</span>
    <span class="n">test_set</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;took {:.2f} seconds&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Preprocessing training data...&#34;</span><span class="p">),</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">train_examples</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">create_instances</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span> <span class="c1"># each sentence contain 2*n_word tuple of context features in word, POS, legal lable and gold_t</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;took {:.2f} seconds&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">embeddings_matrix</span><span class="p">,</span> <span class="n">train_examples</span><span class="p">,</span> <span class="n">dev_set</span><span class="p">,</span> <span class="n">test_set</span><span class="p">,</span>
</code></pre></td></tr></table>
</div>
</div><p>This is creating partial parses object. Treating each sentence as a partial parse with attribute &lsquo;stack&rsquo;, &lsquo;buffer&rsquo;, &lsquo;dependencies&rsquo;, and with method &lsquo;parse_step&rsquo; to update words in stack and buffers according to predicted transitions, the parse method returns dependencies for each transition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">PartialParse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Initializes this partial parse.
</span><span class="s2">        Your code should initialize the following fields:
</span><span class="s2">            self.stack: The current stack represented as a list with the top of the stack as the
</span><span class="s2">                        last element of the list.
</span><span class="s2">            self.buffer: The current buffer represented as a list with the first item on the
</span><span class="s2">                         buffer as the first item of the list
</span><span class="s2">            self.dependencies: The list of dependencies produced so far. Represented as a list of
</span><span class="s2">                    tuples where each tuple is of the form (head, dependent).
</span><span class="s2">                    Order for this list doesn&#39;t matter.
</span><span class="s2">        The root token should be represented with the string &#34;ROOT&#34;
</span><span class="s2">        Args:
</span><span class="s2">            sentence: The sentence to be parsed as a list of words.
</span><span class="s2">                      Your code should not modify the sentence.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="c1"># The sentence being parsed is kept for bookkeeping purposes. Do not use it in your code.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentence</span> <span class="o">=</span> <span class="n">sentence</span>

        <span class="c1">### YOUR CODE HERE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ROOT&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">sentence</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">### END YOUR CODE</span>

    <span class="k">def</span> <span class="nf">parse_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transition</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Performs a single parse step by applying the given transition to this partial parse
</span><span class="s2">        Args:
</span><span class="s2">            transition: A string that equals &#34;S&#34;, &#34;LA&#34;, or &#34;RA&#34; representing the shift, left-arc,
</span><span class="s2">                        and right-arc transitions.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="c1">### YOUR CODE HERE</span>
        <span class="k">if</span> <span class="n">transition</span> <span class="o">==</span> <span class="s2">&#34;S&#34;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">transition</span> <span class="o">==</span> <span class="s2">&#34;LA&#34;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">### END YOUR CODE</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transitions</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Applies the provided transitions to this PartialParse
</span><span class="s2">        Args:
</span><span class="s2">            transitions: The list of transitions in the order they should be applied
</span><span class="s2">        Returns:
</span><span class="s2">            dependencies: The list of dependencies produced when parsing the sentence. Represented
</span><span class="s2">                          as a list of tuples where each tuple is of the form (head, dependent)
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_step</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
</code></pre></td></tr></table>
</div>
</div><p>Next, define the model used to predict the transitions for each set of features in each sentences. This is used when evaluating the dev_set and test_set. It is important to use sess as the argument in the predict method so that the most updated variables (the weight matrices and the bias terms in this cases) in TensorFlow in the training stage can be applied to the evaluation set.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">utils.model</span> <span class="kn">import</span> <span class="n">Model</span> <span class="c1">#want to use its predict_on_batch method</span>

<span class="k">class</span> <span class="nc">ModelWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">sentence_id_to_idx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocessor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentence_id_to_idx</span> <span class="o">=</span> <span class="n">sentence_id_to_idx</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">partial_parses</span><span class="p">):</span> <span class="c1">#model and partial_parses are imported and defined above.</span>
        <span class="n">mb_x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sentence_id_to_idx</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">sentence</span><span class="p">)]])</span> <span class="c1">#get context features, pos, label in ID FORM for each sentence in partial_parses, since dev_set&#39;s word are expressed in id form, rather than character like in train_set, mb_x can be type of &#39;int32&#39;</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">partial_parses</span><span class="p">]</span> <span class="c1">#partial parses are initialized in parse() method below </span>
        <span class="n">mb_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mb_x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span> <span class="c1">#inputs_batch, which is from dev_set</span>
        <span class="n">mb_l</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">legal_labels</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">partial_parses</span><span class="p">]</span>
        
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_on_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">mb_x</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mb_l</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;S&#34;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&#34;LA&#34;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&#34;RA&#34;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pred</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pred</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">eval_batch_size</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span> <span class="c1">#here dataset is dev_set</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sentence_id_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
        <span class="n">n_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_words</span><span class="p">)]</span>
        <span class="c1">#sentence = [j for j in example[&#39;word&#39;]]</span>
        <span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
        <span class="n">sentence_id_to_idx</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">sentence</span><span class="p">)]</span> <span class="o">=</span> <span class="n">i</span>
    
    <span class="n">MW</span> <span class="o">=</span> <span class="n">ModelWrapper</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">sentence_id_to_idx</span><span class="p">)</span>
    <span class="c1">#dependencies = minibatch_parse(sentences, model, eval_batch_size)</span>
    <span class="n">partial_parses</span> <span class="o">=</span> <span class="p">[</span><span class="n">PartialParse</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">]</span>

    <span class="n">unfinished_parse</span> <span class="o">=</span> <span class="n">partial_parses</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">unfinished_parse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">minibatch</span> <span class="o">=</span> <span class="n">unfinished_parse</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eval_batch_size</span><span class="p">]</span>
        <span class="c1"># perform transition and single step parser on the minibatch until it is empty</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">minibatch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">transitions</span> <span class="o">=</span><span class="n">MW</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">minibatch</span><span class="p">)</span> <span class="c1">#the model remembers the optimized variables for the sess, so it can predict on the minibatch from dev_set, get the predicted transitions, feature extractions are done within predict() method in ModelWrapper</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
                <span class="n">minibatch</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">parse_step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="c1">#update the stack and buff for each features (list of context word, pos and labels) in each sentence</span>
            <span class="n">minibatch</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse</span> <span class="k">for</span> <span class="n">parse</span> <span class="ow">in</span> <span class="n">minibatch</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parse</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">parse</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># move to the next batch</span>
        <span class="n">unfinished_parse</span> <span class="o">=</span> <span class="n">unfinished_parse</span><span class="p">[</span><span class="n">eval_batch_size</span><span class="p">:]</span>

    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)):</span>
        <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partial_parses</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
    
    <span class="c1"># get the Unlabeled Accuracy Score (maybe)</span>
    <span class="n">UAS</span> <span class="o">=</span> <span class="n">all_tokens</span> <span class="o">=</span> <span class="mf">0.0</span> 
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
        <span class="n">head</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">head</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="k">for</span> <span class="n">pred_h</span><span class="p">,</span> <span class="n">gold_h</span><span class="p">,</span> <span class="n">gold_l</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">assert</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">id2tok</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">P_PREFIX</span><span class="p">)</span>
            <span class="n">pos_str</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">id2tok</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">P_PREFIX</span><span class="p">):]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">with_punct</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">punct</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">pos_str</span><span class="p">)):</span>
                <span class="n">UAS</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pred_h</span> <span class="o">==</span> <span class="n">gold_h</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">all_tokens</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">UAS</span> <span class="o">/=</span> <span class="n">all_tokens</span>
    <span class="k">return</span> <span class="n">UAS</span><span class="p">,</span> <span class="n">dependencies</span> 
</code></pre></td></tr></table>
</div>
</div><p>Now, the deep neural network can be built in TensorFlow framework</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Holds model hyperparams and data information.
</span><span class="s2">    The config class is used to store various hyperparameters and dataset
</span><span class="s2">    information parameters. Model objects are passed a Config() object at
</span><span class="s2">    instantiation.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">n_features</span> <span class="o">=</span> <span class="mi">36</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">embed_size</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2048</span>
    <span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;english&#39;</span>
    <span class="n">with_punct</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">unlabeled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">lowercase</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">use_pos</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">use_dep</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">use_dep</span> <span class="o">=</span> <span class="n">use_dep</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">unlabeled</span><span class="p">)</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;./data&#39;</span>
    <span class="n">train_file</span> <span class="o">=</span> <span class="s1">&#39;train.conll&#39;</span>
    <span class="n">dev_file</span> <span class="o">=</span> <span class="s1">&#39;dev.conll&#39;</span>
    <span class="n">test_file</span> <span class="o">=</span> <span class="s1">&#39;test.conll&#39;</span>
    <span class="n">embedding_file</span> <span class="o">=</span> <span class="s1">&#39;./data/en-cw.txt&#39;</span>
    
<span class="k">class</span> <span class="nc">ParserModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    Implements a feedforward neural network with an embedding layer and single hidden layer.
</span><span class="s2">    This network will predict which transition should be applied to a given partial parse
</span><span class="s2">    configuration.
</span><span class="s2">    &#34;&#34;&#34;</span>

    <span class="k">def</span> <span class="nf">add_placeholders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
 
        <span class="c1">### YOUR CODE HERE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_placeholder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_features</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_placeholder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_classes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_placeholder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_regul</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1">### END YOUR CODE</span>

    <span class="k">def</span> <span class="nf">create_feed_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs_batch</span><span class="p">,</span> <span class="n">labels_batch</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta_regul</span><span class="o">=</span><span class="mf">10e-7</span><span class="p">):</span>
  
        <span class="c1">### YOUR CODE HERE</span>
        <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_placeholder</span><span class="p">:</span> <span class="n">inputs_batch</span><span class="p">,</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">dropout_placeholder</span><span class="p">:</span> <span class="n">dropout</span><span class="p">,</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">beta_regul</span><span class="p">:</span> <span class="n">beta_regul</span>
                     <span class="p">}</span>
        <span class="k">if</span> <span class="n">labels_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">feed_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_placeholder</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_batch</span>
        <span class="c1">### END YOUR CODE</span>
        <span class="k">return</span> <span class="n">feed_dict</span>

    <span class="k">def</span> <span class="nf">add_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1">### YOUR CODE HERE</span>
        <span class="n">embedded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrained_embeddings</span><span class="p">)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">embedding_lookup</span><span class="p">(</span><span class="n">embedded</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">input_placeholder</span><span class="p">)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_features</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">embed_size</span><span class="p">])</span>
        <span class="c1">### END YOUR CODE</span>
        <span class="k">return</span> <span class="n">embeddings</span>

    <span class="k">def</span> <span class="nf">add_prediction_op</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_embedding</span><span class="p">()</span>
        <span class="c1">### YOUR CODE HERE</span>
        <span class="n">xavier</span> <span class="o">=</span> <span class="n">xavier_weight_init</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s2">&#34;transformation&#34;</span><span class="p">):</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,]))</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_classes</span><span class="p">]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span> <span class="o">=</span> <span class="n">xavier</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_features</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">])</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">xavier</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_classes</span><span class="p">])</span>

            <span class="n">z1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b1</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span>
            <span class="n">h_drop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_placeholder</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">h_drop</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2</span>
        <span class="c1">### END YOUR CODE</span>
        <span class="k">return</span> <span class="n">pred</span>

    <span class="k">def</span> <span class="nf">add_loss_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
 
        <span class="c1">### YOUR CODE HERE</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax_cross_entropy_with_logits_v2</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_placeholder</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_regul</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">l2_loss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="c1">### END YOUR CODE</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">add_training_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>

        <span class="c1">### YOUR CODE HERE</span>
        <span class="n">adam_optim</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
        <span class="n">train_op</span> <span class="o">=</span> <span class="n">adam_optim</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="c1">### END YOUR CODE</span>
        <span class="k">return</span> <span class="n">train_op</span>

    <span class="k">def</span> <span class="nf">train_on_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">inputs_batch</span><span class="p">,</span> <span class="n">labels_batch</span><span class="p">):</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_feed_dict</span><span class="p">(</span><span class="n">inputs_batch</span><span class="p">,</span> <span class="n">labels_batch</span><span class="o">=</span><span class="n">labels_batch</span><span class="p">,</span>
                                     <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">train_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">],</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">run_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span><span class="n">train_examples</span><span class="p">,</span> <span class="n">dev_set</span><span class="p">):</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Progbar</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_examples</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">minibatches</span><span class="p">(</span><span class="n">train_examples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)):</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
            <span class="n">prog</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&#34;train loss&#34;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)])</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Evaluating on dev set&#34;</span><span class="p">),</span>
        <span class="n">dev_UAS</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">dev_set</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;- dev UAS: {:.2f}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dev_UAS</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dev_UAS</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">saver</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span><span class="n">train_examples</span><span class="p">,</span> <span class="n">dev_set</span><span class="p">):</span>
        <span class="n">best_dev_UAS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_epochs</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Epoch {:} out of {:}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_epochs</span><span class="p">))</span>
            <span class="n">dev_UAS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_epoch</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span><span class="n">train_examples</span><span class="p">,</span> <span class="n">dev_set</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dev_UAS</span> <span class="o">&gt;</span> <span class="n">best_dev_UAS</span><span class="p">:</span>
                <span class="n">best_dev_UAS</span> <span class="o">=</span> <span class="n">dev_UAS</span>
                <span class="k">if</span> <span class="n">saver</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;New best dev UAS! Saving model in ./data/weights/parser.weights&#34;</span><span class="p">)</span>
                    <span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;./data/weights/parser.weights&#39;</span><span class="p">)</span>
            <span class="k">print</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">pretrained_embeddings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_embeddings</span> <span class="o">=</span> <span class="n">pretrained_embeddings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Before combining everything together, define the follow methods. minibatches() are used to extract the input batch and lable batch for the feeder in tensorflow; xavier_weight_init() used to randomly generate W and U matrices in the prediction functions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">utils.general_utils</span> <span class="kn">import</span> <span class="n">get_minibatches</span>

<span class="k">def</span> <span class="nf">minibatches</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
    <span class="n">one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">one_hot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">get_minibatches</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">one_hot</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">xavier_weight_init</span><span class="p">():</span>
    <span class="s2">&#34;&#34;&#34;Returns function that creates random tensor.
</span><span class="s2">    The specified function will take in a shape (tuple or 1-d array) and
</span><span class="s2">    returns a random tensor of the specified shape drawn from the
</span><span class="s2">    Xavier initialization distribution.
</span><span class="s2">    Hint: You might find tf.random_uniform useful.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">def</span> <span class="nf">_xavier_initializer</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Defines an initializer for the Xavier distribution.
</span><span class="s2">        Specifically, the output should be sampled uniformly from [-epsilon, epsilon] where
</span><span class="s2">            epsilon = sqrt(6) / &lt;sum of the sizes of shape&#39;s dimensions&gt;
</span><span class="s2">        e.g., if shape = (2, 3), epsilon = sqrt(6 / (2 + 3))
</span><span class="s2">        This function will be used as a variable initializer.
</span><span class="s2">        Args:
</span><span class="s2">            shape: Tuple or 1-d array that species the dimensions of the requested tensor.
</span><span class="s2">        Returns:
</span><span class="s2">            out: tf.Tensor of specified shape sampled from the Xavier distribution.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="c1">### YOUR CODE HERE</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">minval</span><span class="o">=-</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">epsilon</span><span class="p">))</span>
        <span class="c1">### END YOUR CODE</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="c1"># Returns defined initializer function.</span>
    <span class="k">return</span> <span class="n">_xavier_initializer</span>
</code></pre></td></tr></table>
</div>
</div><p>Combining everything to the main() function:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="s2">&#34;=&#34;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;INITIALIZING&#34;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="s2">&#34;=&#34;</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
    <span class="n">preprocessor</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">train_examples</span><span class="p">,</span> <span class="n">dev_set</span><span class="p">,</span> <span class="n">test_set</span> <span class="o">=</span> <span class="n">load_and_preprocess_data</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;./data/weights/&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;./data/weights/&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Building model...&#34;</span><span class="p">),</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ParserModel</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
        <span class="c1">#parser.model = model</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;took {:.2f} seconds</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

        <span class="n">init</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
        <span class="c1"># If you are using an old version of TensorFlow, you may have to use</span>
        <span class="c1"># this initializer instead.</span>
        <span class="c1"># init = tf.initialize_all_variables()</span>
        <span class="n">saver</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
            <span class="c1">#parser.session = sess</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="s2">&#34;=&#34;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TRAINING&#34;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="s2">&#34;=&#34;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">saver</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span><span class="n">train_examples</span><span class="p">,</span> <span class="n">dev_set</span><span class="p">)</span> <span class="c1">#train_examples provide the input_batch and label batch by minibatches() method defined above </span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="s2">&#34;=&#34;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TESTING&#34;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="s2">&#34;=&#34;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Restoring the best model weights found on the dev set&#34;</span><span class="p">)</span>
                <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;./data/weights/parser.weights&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Final evaluation on test set&#34;</span><span class="p">,)</span>
                <span class="n">UAS</span><span class="p">,</span> <span class="n">dependencies</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">test_set</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&#34;- test UAS: {:.2f}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">UAS</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Writing predictions&#34;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;q2_test.predicted.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Done!&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Finally, run the main function with debug mode:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">main</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>The results under debug mode. After 10 epoch of training, UAS is 68.56.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">================================================================================</span>
<span class="n">INITIALIZING</span>
<span class="o">================================================================================</span>
<span class="n">Loading</span> <span class="n">data</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">11.97</span> <span class="n">seconds</span>
<span class="n">Building</span> <span class="n">parser</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">0.09</span> <span class="n">seconds</span>
<span class="n">Loading</span> <span class="n">pretrained</span> <span class="n">embeddings</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">6.36</span> <span class="n">seconds</span>
<span class="n">Vectorizing</span> <span class="n">data</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">0.17</span> <span class="n">seconds</span>
<span class="n">Preprocessing</span> <span class="n">training</span> <span class="n">data</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">3.79</span> <span class="n">seconds</span>
<span class="n">Building</span> <span class="n">model</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">0.52</span> <span class="n">seconds</span>

<span class="o">================================================================================</span>
<span class="n">TRAINING</span>
<span class="o">================================================================================</span>
<span class="n">Epoch</span> <span class="mi">1</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">1.0069</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">45.86</span>
<span class="n">Epoch</span> <span class="mi">2</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.4400</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">53.38</span>
<span class="n">Epoch</span> <span class="mi">3</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.3473</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">58.92</span>
<span class="n">Epoch</span> <span class="mi">4</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.3010</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">61.86</span>
<span class="n">Epoch</span> <span class="mi">5</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.2675</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">62.74</span>
<span class="n">Epoch</span> <span class="mi">6</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.2419</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">64.17</span>
<span class="n">Epoch</span> <span class="mi">7</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.2214</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">65.05</span>
<span class="n">Epoch</span> <span class="mi">8</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.2016</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">67.05</span>
<span class="n">Epoch</span> <span class="mi">9</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.1881</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">67.45</span>
<span class="n">Epoch</span> <span class="mi">10</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">24</span><span class="o">/</span><span class="mi">24</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.1733</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">68.56</span>
</code></pre></td></tr></table>
</div>
</div><p>Training on the full data, the final UAS is 88.91.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">================================================================================</span>
<span class="n">INITIALIZING</span>
<span class="o">================================================================================</span>
<span class="n">Loading</span> <span class="n">data</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">5.62</span> <span class="n">seconds</span>
<span class="n">Building</span> <span class="n">parser</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">4.05</span> <span class="n">seconds</span>
<span class="n">Loading</span> <span class="n">pretrained</span> <span class="n">embeddings</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">6.82</span> <span class="n">seconds</span>
<span class="n">Vectorizing</span> <span class="n">data</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">4.56</span> <span class="n">seconds</span>
<span class="n">Preprocessing</span> <span class="n">training</span> <span class="n">data</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">144.24</span> <span class="n">seconds</span>
<span class="n">Building</span> <span class="n">model</span><span class="o">...</span>
<span class="n">took</span> <span class="mf">0.65</span> <span class="n">seconds</span>

<span class="o">================================================================================</span>
<span class="n">TRAINING</span>
<span class="o">================================================================================</span>
<span class="n">Epoch</span> <span class="mi">1</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.2253</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">82.99</span>
<span class="n">New</span> <span class="n">best</span> <span class="n">dev</span> <span class="n">UAS</span><span class="err">!</span> <span class="n">Saving</span> <span class="n">model</span> <span class="ow">in</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="n">Epoch</span> <span class="mi">2</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.1231</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">85.37</span>
<span class="n">New</span> <span class="n">best</span> <span class="n">dev</span> <span class="n">UAS</span><span class="err">!</span> <span class="n">Saving</span> <span class="n">model</span> <span class="ow">in</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="n">Epoch</span> <span class="mi">3</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.1069</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">86.63</span>
<span class="n">New</span> <span class="n">best</span> <span class="n">dev</span> <span class="n">UAS</span><span class="err">!</span> <span class="n">Saving</span> <span class="n">model</span> <span class="ow">in</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="n">Epoch</span> <span class="mi">4</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.0969</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">87.34</span>
<span class="n">New</span> <span class="n">best</span> <span class="n">dev</span> <span class="n">UAS</span><span class="err">!</span> <span class="n">Saving</span> <span class="n">model</span> <span class="ow">in</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="n">Epoch</span> <span class="mi">5</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.0902</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">87.09</span>
<span class="n">Epoch</span> <span class="mi">6</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.0839</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">87.84</span>
<span class="n">New</span> <span class="n">best</span> <span class="n">dev</span> <span class="n">UAS</span><span class="err">!</span> <span class="n">Saving</span> <span class="n">model</span> <span class="ow">in</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="n">Epoch</span> <span class="mi">7</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.0792</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">88.21</span>
<span class="n">New</span> <span class="n">best</span> <span class="n">dev</span> <span class="n">UAS</span><span class="err">!</span> <span class="n">Saving</span> <span class="n">model</span> <span class="ow">in</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="n">Epoch</span> <span class="mi">8</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.0747</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">88.08</span>
<span class="n">Epoch</span> <span class="mi">9</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.0711</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">88.26</span>
<span class="n">New</span> <span class="n">best</span> <span class="n">dev</span> <span class="n">UAS</span><span class="err">!</span> <span class="n">Saving</span> <span class="n">model</span> <span class="ow">in</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="n">Epoch</span> <span class="mi">10</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">10</span>
<span class="mi">928</span><span class="o">/</span><span class="mi">928</span> <span class="p">[</span><span class="o">============================&gt;.</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETA</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span> <span class="o">-</span> <span class="n">train</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.0675</span><span class="n">Evaluating</span> <span class="n">on</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">dev</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">88.52</span>
<span class="n">New</span> <span class="n">best</span> <span class="n">dev</span> <span class="n">UAS</span><span class="err">!</span> <span class="n">Saving</span> <span class="n">model</span> <span class="ow">in</span> <span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="o">================================================================================</span>
<span class="n">TESTING</span>
<span class="o">================================================================================</span>
<span class="n">Restoring</span> <span class="n">the</span> <span class="n">best</span> <span class="n">model</span> <span class="n">weights</span> <span class="n">found</span> <span class="n">on</span> <span class="n">the</span> <span class="n">dev</span> <span class="nb">set</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">tensorflow</span><span class="p">:</span><span class="n">Restoring</span> <span class="n">parameters</span> <span class="kn">from</span> <span class="nn">.</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">weights</span>
<span class="n">Final</span> <span class="n">evaluation</span> <span class="n">on</span> <span class="n">test</span> <span class="nb">set</span>
<span class="o">-</span> <span class="n">test</span> <span class="n">UAS</span><span class="p">:</span> <span class="mf">88.91</span>
<span class="n">Writing</span> <span class="n">predictions</span>
<span class="n">Done</span><span class="err">!</span>
</code></pre></td></tr></table>
</div>
</div><p>The final dependencies for each transition is in id form and will look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="p">[(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)],</span> <span class="p">[],</span><span class="o">...</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s2">&#34;Hello, World!&#34;</span><span class="p">)</span> 
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">hello-world</span>
  <span class="s">&#34;A function print &#39;Hello world&#39;.&#34;</span>
  <span class="p">[]</span>
  <span class="p">(</span><span class="nb">prn </span><span class="s">&#34;Hello world&#34;</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go-html-template" data-lang="go-html-template"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span><span class="cp">{{</span><span class="w"> </span><span class="na">.Title</span><span class="w"> </span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="cp">{{</span><span class="w"> </span><span class="na">.Title</span><span class="w"> </span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="cp">{{</span><span class="w"> </span><span class="na">.Content</span><span class="w"> </span><span class="cp">}}</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go-html-template" data-lang="go-html-template"><span class="cp">{{</span><span class="w"> </span><span class="nx">partial</span><span class="w"> </span><span class="s">&#34;header.html&#34;</span><span class="w"> </span><span class="na">.</span><span class="w"> </span><span class="cp">}}</span>

  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>posts<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="cp">{{</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">first</span><span class="w"> </span><span class="nx">10</span><span class="w"> </span><span class="na">.Data.Pages</span><span class="w"> </span><span class="cp">}}</span>
    <span class="cp">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="na">.Type</span><span class="w"> </span><span class="s">&#34;post&#34;</span><span class="cp">}}</span>
      <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;</span><span class="cp">{{</span><span class="w"> </span><span class="na">.Permalink</span><span class="w"> </span><span class="cp">}}</span><span class="s">&#34;</span><span class="p">&gt;</span><span class="cp">{{</span><span class="w"> </span><span class="na">.Title</span><span class="w"> </span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
    <span class="cp">{{</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="cp">}}</span>
  <span class="cp">{{</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="cp">}}</span>

  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>pages<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="cp">{{</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="na">.Data.Pages</span><span class="w"> </span><span class="cp">}}</span>
    <span class="cp">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="o">(</span><span class="k">eq</span><span class="w"> </span><span class="na">.Type</span><span class="w"> </span><span class="s">&#34;page&#34;</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="k">eq</span><span class="w"> </span><span class="na">.Type</span><span class="w"> </span><span class="s">&#34;about&#34;</span><span class="o">)</span><span class="w"> </span><span class="cp">}}</span>
      <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;</span><span class="cp">{{</span><span class="w"> </span><span class="na">.Permalink</span><span class="w"> </span><span class="cp">}}</span><span class="s">&#34;</span><span class="p">&gt;</span><span class="cp">{{</span><span class="w"> </span><span class="na">.Type</span><span class="w"> </span><span class="cp">}}</span> - <span class="cp">{{</span><span class="w"> </span><span class="na">.Title</span><span class="w"> </span><span class="cp">}}</span> - <span class="cp">{{</span><span class="w"> </span><span class="na">.RelPermalink</span><span class="w"> </span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
    <span class="cp">{{</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="cp">}}</span>
  <span class="cp">{{</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="cp">}}</span>

<span class="cp">{{</span><span class="w"> </span><span class="nx">partial</span><span class="w"> </span><span class="s">&#34;footer.html&#34;</span><span class="w"> </span><span class="na">.</span><span class="w"> </span><span class="cp">}}</span>
</code></pre></td></tr></table>
</div>
</div><hr>
<p>Detect the language</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">hello</span>

<span class="nx">fun</span> <span class="nf">main</span><span class="p">(</span><span class="nx">args</span><span class="p">:</span> <span class="nx">Array</span><span class="p">&lt;</span><span class="nx">String</span><span class="p">&gt;)</span> <span class="p">{</span>
  <span class="nb">println</span><span class="p">(</span><span class="s">&#34;Hello World!&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&lt;?php
  echo &#39;Hello, World!&#39;;
?&gt;
</code></pre></td></tr></table>
</div>
</div><hr>
<p>By <code>{{&lt; highlight go-html-template &quot;linenos=table,hl_lines=1 3-7,linenostart=199&quot; &gt;}}..{{&lt; / highlight &gt;}}</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="hl"><span class="lnt">199
</span></span><span class="lnt">200
</span><span class="hl"><span class="lnt">201
</span></span><span class="hl"><span class="lnt">202
</span></span><span class="hl"><span class="lnt">203
</span></span><span class="hl"><span class="lnt">204
</span></span><span class="hl"><span class="lnt">205
</span></span><span class="lnt">206
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go-html-template" data-lang="go-html-template"><span class="hl"><span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;main&#34;</span><span class="p">&gt;</span>
</span>  <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="hl">   <span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;title&#34;</span><span class="p">&gt;</span><span class="cp">{{</span><span class="w"> </span><span class="na">.Title</span><span class="w"> </span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span><span class="hl">    <span class="cp">{{</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="na">.Data.Pages</span><span class="w"> </span><span class="cp">}}</span>
</span><span class="hl">        <span class="cp">{{</span><span class="w"> </span><span class="na">.Render</span><span class="w"> </span><span class="s">&#34;summary&#34;</span><span class="cp">}}</span>
</span><span class="hl">    <span class="cp">{{</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="cp">}}</span>
</span><span class="hl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span></code></pre></td></tr></table>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Luyao Peng</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2018-11-05
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/nlp/">NLP</a>
          <a href="/tags/deep-learning/">Deep Learning</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/js-sequence-diagrams/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">JS Sequence Diagrams</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2019-03-04-assignment2/">
            <span class="next-text nav-default">Syntax Highlighting</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  <div id="disqus_thread"></div>
  <script>
  (function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://luyao-1.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="http://localhost:1313" class="iconfont icon-twitter" title="twitter"></a>
      <a href="http://localhost:1313" class="iconfont icon-facebook" title="facebook"></a>
      <a href="http://localhost:1313" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-pocket" title="pocket"></a>
      <a href="http://localhost:1313" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
      <a href="http://localhost:1313" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="http://localhost:1313" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  
  
  <span class="copyright-year">
    &copy; 
    2017 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Luyao Peng</span>
  </span>
</div>


    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
